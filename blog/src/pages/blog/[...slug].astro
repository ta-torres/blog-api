---
export const prerender = false;
import { marked } from 'marked';
import BlogPost from '../../layouts/BlogPost.astro';

marked.setOptions({
  breaks: true,
  gfm: true,
});

const { slug } = Astro.params;

async function fetchPost(postId) {
  try {
    const response = await fetch(`${import.meta.env.PUBLIC_API_URL}api/posts/${postId}`);
    
    if (!response.ok) {
      throw new Error('Failed to fetch posts');
    }
    
    return await response.json();
  } catch (error) {
    console.error('Error fetching post:', error);
    return null;
  }
}

const post = await fetchPost(slug);

if (!post) {
  return Astro.redirect('/404');
}

const htmlContent = marked.parse(post.content);

const postData = {
  title: post.title,
  pubDate: new Date(post.createdAt),
  heroImage: post.heroImage || null,
  description: post.description || '',
  author: post.author,
}
---

<BlogPost 
  {...postData}
>
  <div set:html={htmlContent}></div>
</BlogPost>